<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Minting</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
<div class="bg-white shadow-lg rounded-lg p-8 max-w-md w-full">
    <h1 class="text-2xl font-bold mb-6">Token Minting</h1>
    <form id="mintForm" class="space-y-4">
        <div>
            <label for="tokenSymbol" class="block text-sm font-medium text-gray-700">tokenSymbol:</label>
            <input type="text" id="tokenSymbol" name="tokenSymbol" required
                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
        </div>

        <div>
            <label for="userPublicKey" class="block text-sm font-medium text-gray-700">User Public Key:</label>
            <input type="text" id="userPublicKey" name="userPublicKey" required
                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
        </div>

        <div>
            <label for="quantity" class="block text-sm font-medium text-gray-700">quantity:</label>
            <input type="number" id="quantity" name="quantity" min="1" required
                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
        </div>

        <div>
            <label for="image" class="block text-sm font-medium text-gray-700">Upload Image:</label>
            <input type="file" id="image" name="image" accept="image/*" required
                   class="mt-1 block w-full text-sm text-gray-900 border border-gray-300 rounded-md cursor-pointer focus:outline-none">
        </div>

        <button type="submit"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md shadow-sm transition duration-300 ease-in-out">
            Mint Tokens
        </button>
    </form>

    <div id="responseMessage" class="mt-4 text-sm"></div>
    <div id="tokenInfo" class="hidden mt-4">
        <h2 class="text-lg font-semibold">Token Minting Details</h2>
        <p id="mintAddress" class="mt-2"></p>
        <p id="tokenAccount" class="mt-2"></p>
        <p id="feeTransactionSignature" class="mt-2"></p>
        <p id="metadataUploadOutput" class="mt-2"></p>
    </div>
</div>

<!-- Modal -->
<div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-8 rounded-lg shadow-lg max-w-2xl w-full transform transition-transform duration-300 ease-in-out">
        <span class="close absolute top-4 right-4 text-gray-500 hover:text-gray-800 cursor-pointer text-2xl font-bold">&times;</span>

        <!-- Tailwind Success Component -->
        <div id="successMessage" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-6" role="alert">
            <strong class="font-bold">Success!</strong>
            <span class="block sm:inline"></span> <!-- Text will be injected here -->
        </div>

        <!-- JSON Metadata Display -->
        <div id="metadataDisplay" class="bg-gray-100 border border-gray-300 text-gray-800 px-4 py-3 rounded mb-6">
            <h3 class="font-semibold text-lg mb-2">Metadata</h3>
            <pre class="whitespace-pre-wrap break-words"></pre> <!-- Metadata will be injected here -->
        </div>

        <button onclick="window.location.href='/'"
                class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md shadow-sm transition duration-300 ease-in-out">
            Go to Dashboard
        </button>
    </div>
</div>

<script>
    document.getElementById('mintForm').addEventListener('submit', async function(event) {
        event.preventDefault();

        const tokenSymbol = document.getElementById('tokenSymbol').value;
        const userPublicKey = document.getElementById('userPublicKey').value;
        const quantity = document.getElementById('quantity').value;
        const image = document.getElementById('image').files[0];

        const responseMessage = document.getElementById('responseMessage');
        const tokenInfo = document.getElementById('tokenInfo');
        const successModal = document.getElementById('successModal');
        const successMessage = document.getElementById('successMessage');
        const closeModal = document.querySelector('.close');

        try {
            // Upload image to IPFS
            const formData = new FormData();
            formData.append('file', image);

            const ipfsResponse = await fetch('/upload', {
                method: 'POST',
                body: formData,
            });

            const ipfsData = await ipfsResponse.json();

            if (!ipfsResponse.ok) {
                throw new Error(`IPFS upload failed: ${ipfsData.error}`);
            }

            // Proceed with minting process
            const mintResponse = await fetch('/mint', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    tokenSymbol,
                    userPublicKey,
                    quantity,
                    imageURI: ipfsData.uri
                }),
            });

            const data = await mintResponse.json();

            if (mintResponse.ok) {
                responseMessage.innerHTML = `<p class="text-green-600">Success: ${data.message}</p>`;
                document.getElementById('mintAddress').textContent = `Mint Address: ${data.mintAddress}`;
                document.getElementById('tokenAccount').textContent = `Token Account: ${data.tokenAccount}`;
                document.getElementById('feeTransactionSignature').textContent = `Fee Transaction Signature: ${data.feeTransactionSignature || 'Not Available'}`;
                document.getElementById('metadataUploadOutput').textContent = `Metadata Upload Output: ${data.metadataUploadOutput}`;

                tokenInfo.classList.remove('hidden');

                // Inject success message and show the modal
                successMessage.querySelector('span').textContent = `Mint and transfer successful! Mint Address: ${data.mintAddress}`;
                successModal.classList.remove('hidden');
                document.getElementById('mintForm').reset(); // Reset form after successful submission
            } else {
                responseMessage.innerHTML = `<p class="text-red-600">Error: ${data.error}</p>`;
                tokenInfo.classList.add('hidden');
            }
        } catch (error) {
            responseMessage.innerHTML = `<p class="text-red-600">Unexpected Error: ${error.message}</p>`;
            tokenInfo.classList.add('hidden');
        }

        // Close modal functionality
        closeModal.addEventListener('click', function() {
            successModal.classList.add('hidden');
        });

        window.addEventListener('click', function(event) {
            if (event.target === successModal) {
                successModal.classList.add('hidden');
            }
        });
    });

</script></body>
</html>
